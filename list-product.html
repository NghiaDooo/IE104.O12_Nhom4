<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product List</title>
    <link rel="stylesheet" href="./styles/globals.css">
    <link rel="stylesheet" href="./styles/styleguide.css">
    <link rel="stylesheet" href="./styles/list-product.css">
</head>

<body>
    <div id="navbar"></div>
    <div class="slider">
        <div class="slides">
            <input type="radio" name="radio-btn" id="radio1">
            <input type="radio" name="radio-btn" id="radio2">
            <input type="radio" name="radio-btn" id="radio3">
            <input type="radio" name="radio-btn" id="radio4">
            <div class="slide first">
                <img src="./assets/images/slider-banner/banner1.png" alt="">
            </div>
            <div class="slide">
                <img src="./assets/images/slider-banner/banner2.png" alt="">
            </div>
            <div class="slide">
                <img src="./assets/images/slider-banner/banner3.png" alt="">
            </div>
            <div class="slide">
                <img src="./assets/images/slider-banner/banner4.png" alt="">
            </div>

            <div class="navigation-auto">
                <div class="auto-btn1"></div>
                <div class="auto-btn2"></div>
                <div class="auto-btn3"></div>
                <div class="auto-btn4"></div>
            </div>
        </div>

        <div class="navigation-manual">
            <label for="radio1" class="manual-btn"></label>
            <label for="radio2" class="manual-btn"></label>
            <label for="radio3" class="manual-btn"></label>
            <label for="radio4" class="manual-btn"></label>
        </div>
    </div>
    <div class="filter-brand">
        <a class="brand-filter-button" onClick="handleFilterClick(event)" href="?brand=apple"> <img
                src="./assets/images/filter/logo-iphone-220x48.png" alt=""></a>
        <a class="brand-filter-button" onClick="handleFilterClick(event)" href="?brand=samsung"> <img
                src="./assets/images/filter/samsungnew-220x48-1.png" alt=""></a>
        <a class="brand-filter-button" onClick="handleFilterClick(event)" href="?brand=oppo"> <img
                src="./assets/images/filter/OPPO42-b_5.jpg" alt=""></a>
        <a class="brand-filter-button" onClick="handleFilterClick(event)" href="?brand=xiaomi"> <img
                src="./assets/images/filter/logo-xiaomi-220x48-5.png" alt=""></a>
        <a class="brand-filter-button" onClick="handleFilterClick(event)" href="?brand=nokia"><img
                src="./assets/images/filter/Nokia42-b_21.jpg" alt=""></a>
    </div>
    <div class="sort-product-container">

    </div>
    <div class="products-content-container">
        <div class="left-filter-container">
            <ul class="filter-list">
                <li class="label">
                    <label>Loại</label>
                    <ul class="filter-box">
                        <li><a class="filter-button" onClick="handleFilterClick(event)" href="?type=all">All</a>
                        </li>
                        <li><a class="filter-button" onClick="handleFilterClick(event)" href="?type=phone">Điện
                                thoại</a></li>
                        <li><a class="filter-button" onClick="handleFilterClick(event)" href="?type=headphone">Tai
                                nghe</a></li>
                        <li><a class="filter-button" onClick="handleFilterClick(event)" href="?type=backup-charging">Sạc
                                dự
                                phòng</a></li>
                        <li><a class="filter-button" onClick="handleFilterClick(event)" href="?type=charging-cable">Cáp
                                sạc</a></li>
                    </ul>
                </li>
                <li class="label">
                    <label>Giá</label>
                    <ul class="filter-box">
                        <li><a class="filter-button" onClick="handleFilterClick(event)" href="?price=all">All</a>
                        </li>
                        <li><a class="filter-button" onClick="handleFilterClick(event)" href="?price=0-2000000">Dưới
                                2 triệu</a>
                        </li>
                        <li><a class="filter-button" onClick="handleFilterClick(event)" href="?price=2000000-4000000">Từ
                                2 đến 4
                                triệu</a></li>
                        <li><a class="filter-button" onClick="handleFilterClick(event)" href="?price=4000000-7000000">Từ
                                4 đến 7
                                triệu</a></li>
                        <li><a class="filter-button" onClick="handleFilterClick(event)"
                                href="?price=7000000-13000000">Từ 7 đến 13
                                triêu</a></li>
                        <li><a class="filter-button" onClick="handleFilterClick(event)"
                                href="?price=13000000-20000000">Từ 13 đến 20
                                triệu</a></li>
                        <li><a class="filter-button" onClick="handleFilterClick(event)" href="?price=20000000-0">Trên
                                20 triệu</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="list-product-container">
            <div id="list-product" class="list-product">
                <button id="btn-see-more" class="btn-see-more" onclick="loadMoreProduct()">Xem thêm</button>
            </div>

        </div>

    </div>
    <div id="footer"></div>

    <script src="./js/navbar.js"></script>
    <script src="./js/footer.js"></script>
    <script src="./js/common.js"></script>
    <script src="./data/data.js"></script>
    <script>
        const products = data;

        // Đếm số cột của grid container
        let gridContainer = document.querySelector('.list-product');
        let computedStyle = window.getComputedStyle(gridContainer);
        let gridColumnValue = computedStyle.getPropertyValue('grid-template-columns');
        let gridColumnNumbers = gridColumnValue.split(' ').map(column => parseInt(column, 10)).length;
        let limitedProducts = gridColumnNumbers * 2;
        let listProduct = data;
        console.log(gridColumnNumbers)

        document.addEventListener('DOMContentLoaded', function () {
            let counter = 2;
            setInterval(function () {
                document.getElementById('radio' + counter).checked = true;
                counter++;
                if (counter > 4) {
                    counter = 1;
                }
            }, 5000);

        });

        function loadFilterUI() {
            let currentUrl = window.location.href;
            let filterButtons = document.querySelectorAll('.filter-box .filter-button');

            // Kiểm tra nếu currentUrl không chứa bất kỳ giá trị nào trong href của thẻ "All"
            if (!currentUrl.includes('?')) {

                let allElements = document.querySelectorAll('.filter-list .filter-box a[href*="=all"]');

                allElements.forEach(function (element) {
                    element.classList.add('filter-button-active');
                });
                return;
            }

            function paramsMatch(currentUrl, hrefValue) {
                // Escape các ký tự đặc biệt trong hrefValue để tránh chúng được hiểu là các biểu thức chính quy
                let escapedHrefValue = hrefValue.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

                // Tạo biểu thức chính quy với hrefValue và không quan trọng đến dấu ? (không gian trắng không quan trọng)
                let regex = new RegExp(escapedHrefValue.replace(/\?/g, "\\?"), "i");

                // Kiểm tra xem regex có khớp với currentUrl hay không
                return regex.test(currentUrl);
            }

            filterButtons.forEach(function (button) {
                let hrefValue = button.getAttribute('href');

                if (!currentUrl.includes(hrefValue.toString().split('?')[1].split('=')[0])) {
                    let filterBox = button.closest('.filter-box');
                    let filterButton = filterBox.querySelector('a[href*="=all"]');
                    if (filterButton) {
                        filterButton.classList.add('filter-button-active');
                    }
                }

                if (paramsMatch(currentUrl, hrefValue)) {
                    button.classList.add('filter-button-active');
                }
            });
        }


        function handleFilterClick(event) {
            event.preventDefault();
            let filterBox = event.target.closest('.filter-box');
            if (filterBox) {
                let filterButtons = filterBox.querySelectorAll('.filter-button');
                filterButtons.forEach(function (button) {
                    button.classList.remove('filter-button-active');
                });
                event.target.classList.add('filter-button-active');
            }

            const filterValue = event.currentTarget.getAttribute('href').split('=')[1];
            const filterType = event.currentTarget.getAttribute('href').split('=')[0].split('?')[1];
            if (filterType == 'brand') {
                if (event.currentTarget.classList.contains("filter-active")) {
                    event.currentTarget.classList.remove("filter-active");
                } else {
                    event.currentTarget.classList.add("filter-active");
                }
            }
            updateUrlParameter(filterType, filterValue);
            filterProductsByUrl()
        }

        function updateUrlParameter(param, value) {
            const url = new URL(window.location.href);
            // Kiểm tra nếu giá trị là 'all' thì xóa tham số khỏi URL
            if (value === 'all') {
                url.searchParams.delete(param);

            } else {
                if (param == 'brand') {
                    const values = url.searchParams.getAll(param);
                    const valuesArray = values.length > 0 ? values.toString().split(',') : [];

                    if (valuesArray.includes(value)) {
                        const index = valuesArray.indexOf(value);
                        valuesArray.splice(index, 1);
                    } else {

                        valuesArray.push(value);
                    }

                    if (valuesArray.length > 0) {
                        url.searchParams.set(param, valuesArray.join(','));
                    }
                    else
                        url.searchParams.delete(param);
                } else {
                    url.searchParams.set(param, value);
                }


            }
            history.pushState(null, null, url.href);
        }

        function filterProductsByUrl() {
            const urlParams = new URLSearchParams(window.location.href.split('?')[1]);

            const typeParam = urlParams.get('type');
            const priceParam = urlParams.get('price');
            const brandParam = urlParams.get('brand');

            //translate type to Vietnamese
            let vietnameseType;
            switch (typeParam) {
                case 'phone':
                    vietnameseType = 'Điện thoại';
                    break;
                case 'headphone':
                    vietnameseType = 'Tai nghe';
                    break;
                case 'backup-charging':
                    vietnameseType = 'Sạc dự phòng';
                    break;
                case 'charging-cable':
                    vietnameseType = 'Adapter sạc, chuyển đổi';
                    break;
                default:
                    vietnameseType = typeParam;
                    break;
            }

            const priceRange = priceParam
                ? priceParam.split('-').map(value => (value.toLowerCase() === 'all' ? null : Number(value)))
                : null;

            // Filter products based on URL parameters
            const filteredProducts = data.filter(product => {
                const isTypeMatch =
                    !typeParam || product.cate.toLowerCase() === vietnameseType.toLowerCase();
                const isPriceMatch =
                    !priceRange ||
                    (priceRange[0] === 0 || product.price >= priceRange[0]) &&
                    (priceRange[1] === 0 || product.price <= priceRange[1]);
                const isBrandMatch =
                    !brandParam || product.brand.toLowerCase() === brandParam.toLowerCase();

                return isTypeMatch && isPriceMatch && isBrandMatch;
            });
            limitedProducts = gridColumnNumbers * 2;
            listProduct = filteredProducts;
            updateProductList();
        }

        async function updateProductList() {
            await loadFilterUI();
            try {

                await (async () => {

                    const productListContainer = document.getElementById('list-product');
                    productListContainer.innerHTML = `<button id="btn-see-more" class="btn-see-more" onclick="loadMoreProduct()">Xem thêm</button>`;

                })();

                if (listProduct.length === 0) {
                    alert("Không tìn thấy sản phẩm!");
                }
                else {
                    const productListContainer = document.getElementById('list-product');
                    showLimitedProducts(listProduct, productListContainer, limitedProducts);
                    isShowedAllProducts();
                }
            } catch (error) {
                console.error('Error:', error);
            }

        }



        function isShowedAllProducts() {
            const btnSeeMore = document.getElementById("btn-see-more");
            if (listProduct == null) {
                btnSeeMore.style.display = 'none';
                return
            }
            if (limitedProducts >= listProduct.length)

                btnSeeMore.style.display = 'none';
            else
                btnSeeMore.style.display = 'block';
        }

        function loadMoreProduct() {
            if (limitedProducts <= listProduct.length) {
                limitedProducts += gridColumnNumbers;
                showLimitedProducts(listProduct, document.getElementById("list-product"), limitedProducts);
            }
            isShowedAllProducts();

        }

        document.addEventListener("DOMContentLoaded", () => {
            filterProductsByUrl();
            updateProductList();
        });


    </script>
</body>

</html>